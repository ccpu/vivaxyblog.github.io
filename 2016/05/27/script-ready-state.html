<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link rel="shortcut icon" href="/css/vivaxy.icon.png">
    <link type="text/css" rel="stylesheet" href="/css/reset.css">
    <link type="text/css" rel="stylesheet" href="/css/main.css">
    <link type="text/css" rel="stylesheet" href="/css/syntax.css">
    <link rel="alternate" type="application/atom+xml" title="vivaxy blog" href="/atom.xml"/>
    <title>script 标签的加载在不同浏览器中的表现</title>
</head>
<body>
<div class="container">
    <a href="/" class="card hover-left">
    <div class="content">
        <h1>script 标签的加载在不同浏览器中的表现</h1>
        <div class="date">2016-05-27</div>
    </div>
    <div class="icon-arrow-left"></div>
</a>
<div class="card">
    <div class="content">
        <h2>起因</h2>

<p>在阅读 neuron.js 源码时发现了下面一段代码：</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">DOC</span> <span class="o">=</span> <span class="nb">document</span><span class="p">;</span>

<span class="c1">// never use `document.body` which might be NULL during downloading of the document.</span>
<span class="kd">var</span> <span class="nx">HEAD</span> <span class="o">=</span> <span class="nx">DOC</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>

<span class="kd">function</span> <span class="nx">load_js</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">DOC</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>

  <span class="nx">node</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">src</span><span class="p">;</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="nx">js_onload</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">HEAD</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">HEAD</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">HEAD</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">js_onload</span> <span class="o">=</span> <span class="nx">DOC</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">).</span><span class="nx">readyState</span>
  <span class="c1">// @param {DOMElement} node</span>
  <span class="c1">// @param {!function()} callback asset.js makes sure callback is not NULL</span>
  <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">rs</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">readyState</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rs</span> <span class="o">===</span> <span class="s1">&#39;loaded&#39;</span> <span class="o">||</span> <span class="nx">rs</span> <span class="o">===</span> <span class="s1">&#39;complete&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>
        <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">};</span>
</code></pre></div>
<p>上面这段代码在 cortex@6.2.4 中，然而 cortex@6.2.3 中的 neuron.js 中的一段确稍有不同。</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">load_js</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">DOC</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>

  <span class="nx">node</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">src</span><span class="p">;</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="nx">js_onload</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">HEAD</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// blabla</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">HEAD</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">HEAD</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
  <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>这里比最新版本多了个 setTimeout 方法。</p>

<p>可是却在 IE10 及以下的版本中报错了。报错的原因是 removeChild 在 insertBefore 方法之前执行了。</p>

<p>那么为什么会报错呢？script 标签是在被添加到 dom 树后再开始加载还是设置了 src 后开始加载呢？</p>

<h2>经过</h2>

<p>来测试下：</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;index.css&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>vivaxy<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;script&gt;</span>
    <span class="kd">var</span> <span class="nx">HEAD</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>

    <span class="nx">node</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;loaded&#39;</span> <span class="o">||</span> <span class="nx">node</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;complete&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">node</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;async.js&#39;</span><span class="p">;</span>

    <span class="nx">HEAD</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">HEAD</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>async.js 中</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;executed&#39;</span><span class="p">);</span>
</code></pre></div>
<p>这段代码会异步加载 async.js ，并且在 script 标签的加载后打印 loaded ，同时在 async.js 执行时打印 executed 。</p>

<p>首先注释掉 <code>HEAD.insertBefore(node, HEAD.firstChild);</code> ，在 IE10 及以下的浏览器中执行的结果是会显示 load 。在 IE11 和 chrome 中则不显示任何内容。</p>

<h2>结果</h2>

<p>说明 IE10 及以下的版本会在 script 设置了 src 后开始加载脚本。在所有浏览器中，script 被添加在 dom 树中后才会执行。</p>

    </div>
</div>
<div class="card">
    <!-- 多说 start -->
    <div class="ds-thread" data-thread-key="/2016/05/27/script-ready-state" data-title="script 标签的加载在不同浏览器中的表现" data-url="/2016/05/27/script-ready-state.html"></div>
    <script type="text/javascript" charset="utf-8" src="/js/duoshuo/duoshuo.js"></script>
    <!-- 多说  end  -->
</div>

    <a href="javascript:document.body.scrollIntoView(true)" class="card hover-top">
        <div class="content">
            <div class="date">© Copyright 2011 ~ 2016 by vivaxy</div>
        </div>
    </a>
</div>
</body>
<script type="text/javascript" src="/js/analysis/ba.js"></script>
</html>
